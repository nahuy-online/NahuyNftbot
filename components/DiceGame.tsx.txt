import React, { useState } from 'react';
import { Currency, UserProfile } from '../types';
import { DICE_ATTEMPT_PRICES, PACK_SIZES } from '../constants';
import { purchaseItem, rollDice } from '../services/mockApi';

interface DiceGameProps {
  user: UserProfile;
  onUpdate: () => void;
}

export const DiceGame: React.FC<DiceGameProps> = ({ user, onUpdate }) => {
  const [view, setView] = useState<'play' | 'buy'>('play');
  const [rolling, setRolling] = useState(false);
  const [lastRoll, setLastRoll] = useState<number | null>(null);
  
  // Buy State
  const [selectedCurrency, setSelectedCurrency] = useState<Currency>(Currency.STARS);
  const [selectedPack, setSelectedPack] = useState<number>(1);
  const [buyLoading, setBuyLoading] = useState(false);

  const handleRoll = async () => {
    if (user.diceBalance.available <= 0) {
        if (window.Telegram?.WebApp?.HapticFeedback) {
             window.Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
        }
        setView('buy');
        return;
    }

    setRolling(true);
    setLastRoll(null);
    
    // Trigger impact feedback on start
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }

    try {
        const result = await rollDice();
        // Wait for animation
        setTimeout(() => {
            setLastRoll(result);
            setRolling(false);
            onUpdate();
            
            // Success feedback
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }, 800); 
    } catch (e) {
        setRolling(false);
        alert("Error rolling dice");
    }
  };

  const handleBuyAttempts = async () => {
    setBuyLoading(true);
    try {
        await purchaseItem('dice', selectedPack, selectedCurrency);
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        alert(`Bought ${selectedPack} attempts!`);
        onUpdate();
        setView('play');
    } catch (e) {
        alert("Purchase failed");
    } finally {
        setBuyLoading(false);
    }
  };

  const getDiceFace = (num: number) => {
      const faces = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
      return faces[num] || 'üé≤';
  };

  if (view === 'buy') {
    const price = (DICE_ATTEMPT_PRICES[selectedCurrency] * selectedPack).toFixed(selectedCurrency === Currency.STARS ? 0 : 2);
    
    return (
        <div className="p-5 pb-24 animate-fade-in min-h-full">
            <button onClick={() => setView('play')} className="mb-6 px-4 py-2 bg-gray-800 rounded-lg text-sm text-gray-300 hover:text-white flex items-center w-fit transition-colors">
                ‚Üê Back to Game
            </button>
            <div className="space-y-6">
                <div className="text-center">
                    <h2 className="text-2xl font-bold mb-1">Get More Attempts</h2>
                    <p className="text-gray-400 text-sm">Buy attempts to win more NFTs.</p>
                </div>

                {/* Currency Selector */}
                <div className="grid grid-cols-3 gap-2">
                    {(Object.values(Currency) as Currency[]).map((curr) => (
                        <button
                        key={curr}
                        onClick={() => setSelectedCurrency(curr)}
                        className={`py-3 rounded-xl text-sm font-bold border transition-all ${
                            selectedCurrency === curr
                            ? 'bg-green-600 border-green-500 text-white shadow-lg'
                            : 'bg-gray-800 border-gray-700 text-gray-400'
                        }`}
                        >
                        {curr}
                        </button>
                    ))}
                </div>

                {/* Pack Selector */}
                <div className="grid grid-cols-4 gap-2">
                {PACK_SIZES.map((size) => (
                    <button
                    key={size}
                    onClick={() => setSelectedPack(size)}
                    className={`py-4 rounded-xl text-sm font-bold border transition-all ${
                        selectedPack === size
                        ? 'bg-white text-black border-white shadow-lg'
                        : 'bg-gray-800 border-gray-700 text-gray-400'
                    }`}
                    >
                    {size}
                    </button>
                ))}
                </div>

                <div className="fixed bottom-24 left-0 right-0 px-5 max-w-md mx-auto">
                    <button
                        onClick={handleBuyAttempts}
                        disabled={buyLoading}
                        className="w-full py-4 rounded-xl font-bold text-lg bg-green-500 hover:bg-green-400 text-white shadow-[0_0_20px_rgba(34,197,94,0.3)] transition-all active:scale-95 disabled:opacity-50"
                    >
                        {buyLoading ? 'Processing...' : `Pay ${price} ${selectedCurrency}`}
                    </button>
                </div>
            </div>
        </div>
    );
  }

  // Play View
  return (
    <div className="p-4 flex flex-col items-center justify-center min-h-[75vh] pb-24 relative overflow-hidden">
      {/* Background Ambience */}
      <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-64 h-64 bg-green-500/10 rounded-full blur-3xl pointer-events-none"></div>

      <div className="text-center mb-10 z-10">
        <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-gray-500 mb-2 italic">
            LUCKY DICE
        </h1>
        <p className="text-gray-400 font-medium">Roll high, win big.</p>
      </div>

      <div className="relative mb-12 z-10">
        <div className={`
            w-40 h-40 bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl 
            flex items-center justify-center border border-white/10 shadow-2xl
            transition-all duration-300
            ${rolling ? 'dice-animation border-green-500/50 shadow-green-500/20' : ''}
            ${lastRoll ? 'scale-105 border-white/30' : ''}
        `}>
            <span className={`text-8xl select-none filter drop-shadow-lg ${rolling ? 'blur-[2px]' : ''}`}>
               {lastRoll ? getDiceFace(lastRoll) : 'üé≤'}
            </span>
        </div>
        
        {lastRoll && !rolling && (
            <div className="absolute -bottom-16 left-1/2 -translate-x-1/2 w-max animate-fade-in">
                <div className="bg-green-500 text-black font-bold px-4 py-2 rounded-full shadow-lg text-sm">
                    YOU WON {lastRoll} NFT!
                </div>
            </div>
        )}
      </div>

      <div className="w-full max-w-xs space-y-4 z-10">
        <button
            onClick={handleRoll}
            disabled={rolling}
            className={`w-full py-5 rounded-2xl font-bold text-xl shadow-xl transition-all active:scale-95 border border-white/5 relative overflow-hidden group ${
                rolling ? 'bg-gray-700 cursor-wait' : 'bg-white text-black hover:bg-gray-100'
            }`}
        >
            <span className="relative z-10">{rolling ? 'ROLLING...' : 'ROLL DICE'}</span>
            {!rolling && <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500"></div>}
        </button>

        <div className="flex justify-between items-center bg-gray-800/50 px-5 py-3 rounded-xl border border-white/5">
            <span className="text-gray-400 text-sm font-medium">Attempts remaining</span>
            <span className={`font-mono font-bold text-lg ${user.diceBalance.available === 0 ? 'text-red-400' : 'text-green-400'}`}>
                {user.diceBalance.available}
            </span>
        </div>

        {user.diceBalance.available === 0 && (
             <button
                onClick={() => setView('buy')}
                className="w-full py-3 rounded-xl font-medium text-sm text-green-400 border border-green-500/30 bg-green-500/10 hover:bg-green-500/20 transition-colors"
            >
                + Buy More Attempts
            </button>
        )}
      </div>
    </div>
  );
};